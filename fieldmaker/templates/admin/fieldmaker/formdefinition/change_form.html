{% extends "admin/change_form.html" %}
{% load i18n %}

{% block extrahead %}
{{block.super}}
<script type="text/javascript">
(function($) {
    $(document).ready(function() {
        get_field_def = function(key) {
            return $("#id-field-defs > ."+key);
        }
        get_widget_def = function(key) {
            return $("#id-widget-defs > ."+key);
        }
        
        register_dynamic_set = function() {
            var $this = $(this);
            var prefix = $this.attr('data-prefix');
            if (!prefix) return;
            var rows = $this.children('table').children('tbody').children('.dynamic-form');
            console.log(rows)
            if (!rows) return;
            rows.formset({
                prefix: prefix,
                addText: "Add another Field Entry",
                formCssClass: "dynamic-form",
                deleteCssClass: "inline-deletelink",
                deleteText: "Remove",
                emptyCssClass: "empty-form"
            });
        }
        
        $('.dynamic-set').each(register_dynamic_set);
        
        $('.vFieldSelectorField').live('change', function() {
            var key = $(this).val();
            if (!key) return;
            var prefix = $(this).attr('name').split('-');
            prefix.pop();
            prefix = prefix.join('-') + '-field_spec';

            var field_form = get_field_def(key).clone().addClass('vFieldSpecField');
            console.log(field_form)
            var field_spec = $(this).parents('table:first').find('.vFieldSpecField');
            field_form.find(':input').each(function() {
                var field_name = $(this).attr('name');
                $(this).attr('name', field_name.replace(/.*\-/, prefix+'-'));
            });
            field_form.attr('data-prefix', prefix);
            field_spec.replaceWith(field_form)
            
            if (field_form.hasClass('dynamic-set')) {
                //field_form.each(register_dynamic_set);
            }
        });
        $('.vWidgetSelectorField').live('change', function() {
            var key = $(this).val();
            if (!key) return;
            var prefix = $(this).attr('name').split('-');
            prefix.pop();
            prefix = prefix.join('-') + '-widget_spec';

            var field_form = get_widget_def(key).clone();
            var field_spec = $(this).parents('table:first').find('table.vWidgetSpecField');
            field_form.find(':input').each(function() {
                var field_name = $(this).attr('name');
                $(this).attr('name', field_name.replace(/.*\-/, prefix+'-'));
            });
            field_form.children().appendTo(field_spec.empty())
        });
    });
})(django.jQuery);
</script>
{% endblock %}

{% block object-tools-items %}
{{ block.super }}
<li><a href="preview/" class="previewlink">{% trans "Preview" %}</a></li>
{% endblock %}

{% block form_top %}
{{block.super}}
<div style="display:none" id="id-field-defs">
{% for entry in adminform.form.field_forms.itervalues %}
{{entry}}
{% endfor %}
</div>

<div style="display:none" id="id-widget-defs">
{% for entry in adminform.form.widget_forms.itervalues %}
{{entry}}
{% endfor %}
</div>
{% endblock %}
